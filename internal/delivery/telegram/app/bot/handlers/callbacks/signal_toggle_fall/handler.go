// /internal/delivery/telegram/app/bot/handlers/callbacks/signal_toggle_fall/handler.go
package signal_toggle_fall

import (
	"fmt"

	"crypto-exchange-screener-bot/internal/delivery/telegram/app/bot/constants"
	"crypto-exchange-screener-bot/internal/delivery/telegram/app/bot/handlers"
	"crypto-exchange-screener-bot/internal/delivery/telegram/app/bot/handlers/base"
	signal_settings_svc "crypto-exchange-screener-bot/internal/delivery/telegram/services/signal_settings"
)

// signalToggleFallHandler —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–∞–¥–µ–Ω–∏–∏
type signalToggleFallHandler struct {
	*base.BaseHandler
	service signal_settings_svc.Service
}

// NewHandler —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–∞–¥–µ–Ω–∏–∏
func NewHandler(service signal_settings_svc.Service) handlers.Handler {
	return &signalToggleFallHandler{
		BaseHandler: &base.BaseHandler{
			Name:    "signal_toggle_fall_handler",
			Command: constants.CallbackSignalToggleFall,
			Type:    handlers.TypeCallback,
		},
		service: service,
	}
}

// Execute –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É callback –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–∞–¥–µ–Ω–∏–∏
func (h *signalToggleFallHandler) Execute(params handlers.HandlerParams) (handlers.HandlerResult, error) {
	if params.User == nil {
		return handlers.HandlerResult{}, fmt.Errorf("–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω")
	}

	// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞
	serviceParams := signal_settings_svc.SignalSettingsParams{
		Action: "toggle_fall",
		UserID: params.User.ID,
		ChatID: params.ChatID,
		Value:  !params.User.NotifyFall, // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–µ
	}

	// –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
	result, err := h.service.Exec(serviceParams)
	if err != nil {
		return handlers.HandlerResult{}, fmt.Errorf("–æ—à–∏–±–∫–∞ –≤ —Å–µ—Ä–≤–∏—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤: %w", err)
	}

	// –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
	message := fmt.Sprintf(
		"üìâ *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–∞–¥–µ–Ω–∏—è*\n\n%s\n\n"+
			"–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –º–µ–Ω—é —Å–∏–≥–Ω–∞–ª–æ–≤.",
		result.Message,
	)

	// –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
	keyboard := map[string]interface{}{
		"inline_keyboard": [][]map[string]string{
			{
				{"text": constants.ButtonTexts.Back, "callback_data": constants.CallbackSignalsMenu},
			},
		},
	}

	return handlers.HandlerResult{
		Message:  message,
		Keyboard: keyboard,
		Metadata: map[string]interface{}{
			"user_id":       params.User.ID,
			"notify_fall":   result.NewValue,
			"updated_field": result.UpdatedField,
		},
	}, nil
}
