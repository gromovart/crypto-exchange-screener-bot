#!/bin/bash
echo "ðŸ“… Ð•Ð–Ð•Ð”ÐÐ•Ð’ÐÐžÐ• Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ«"
echo "================================="
echo "Ð”Ð°Ñ‚Ð°: $(date)"
echo ""

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ dev)
ENV=${1:-dev}
ENV_FILE="configs/$ENV/.env"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
REPORT_DIR="reports/daily_$(date +%Y%m%d)_$ENV"
mkdir -p "$REPORT_DIR"

echo "ðŸŽ¯ ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ: $ENV"
echo "ðŸ“ Ð¤Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸: $ENV_FILE"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
if [ ! -f "$ENV_FILE" ]; then
    echo "âŒ Ð¤Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $ENV_FILE"
    echo "   Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ: make config-init ENV=$ENV"
    exit 1
fi

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹
echo "1. Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
make test-all ENV=$ENV 2>&1 | tee "$REPORT_DIR/full_test.log"

echo ""
echo "2. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸..."
make test ENV=$ENV 2>&1 | tee "$REPORT_DIR/coverage.log"

echo ""
echo "3. Ð¢ÐµÑÑ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸..."
make check-config ENV=$ENV 2>&1 | tee "$REPORT_DIR/config_check.log"

echo ""
echo "4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
make lint 2>&1 | tee "$REPORT_DIR/security.log"

echo ""
echo "5. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
cat > "$REPORT_DIR/summary.md" << EOF
# Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸
Ð”Ð°Ñ‚Ð°: $(date)
ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ: $ENV
ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ: $ENV_FILE

## Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

### 1. ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
\`\`\`
$(tail -10 "$REPORT_DIR/full_test.log")
\`\`\`

### 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
\`\`\`
$(tail -5 "$REPORT_DIR/config_check.log")
\`\`\`

### 3. ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¸ ÐºÐ¾Ð´
\`\`\`
$(tail -5 "$REPORT_DIR/coverage.log")
\`\`\`

### 4. Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ (lint)
\`\`\`
$(tail -5 "$REPORT_DIR/security.log")
\`\`\`

## Ð¡Ñ‚Ð°Ñ‚ÑƒÑ
$(if grep -q "Ð’Ð¡Ð• Ð¢Ð•Ð¡Ð¢Ð« ÐŸÐ ÐžÐ™Ð”Ð•ÐÐ«" "$REPORT_DIR/full_test.log"; then
    echo "âœ… Ð’Ð¡Ð• Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ« Ð ÐÐ‘ÐžÐ¢ÐÐ®Ð¢ ÐÐžÐ ÐœÐÐ›Ð¬ÐÐž"
elif grep -q "Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢ ÐšÐžÐ Ð Ð•ÐšÐ¢ÐÐž" "$REPORT_DIR/full_test.log"; then
    echo "âœ… Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢ ÐšÐžÐ Ð Ð•ÐšÐ¢ÐÐž"
else
    echo "âš ï¸  Ð¢Ð Ð•Ð‘Ð£Ð•Ð¢Ð¡Ð¯ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•"
fi)
EOF

echo "âœ… Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾"
echo "ðŸ“ ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð²: $REPORT_DIR"
echo ""
echo "ðŸ“‹ ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚:"
cat "$REPORT_DIR/summary.md" | tail -10

# ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ:
# ./scripts/daily_test.sh dev      # Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ dev Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
# ./scripts/daily_test.sh prod     # Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ prod Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ